<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1" />
  <title>Portfolio - About</title>
  <style>
/* ===== FONTS ===== */
@font-face {
  font-family: 'MacklinSansBold';
  src: url('assets/fonts/MacklinSans-Bold.ttf') format('truetype');
  font-weight: bold;
}
@font-face {
  font-family: 'Monospace821Bold';
  src: url('assets/fonts/MONOSPACE821BOLDBT.TTF') format('truetype');
  font-weight: bold;
}
@font-face {
  font-family: 'Monospace821';
  src: url('assets/fonts/MONOSPACE821BT.TTF') format('truetype');
  font-weight: normal;
}

/* ===== BASE ===== */
body { 
  margin: 0; 
  overflow: hidden;
  touch-action: none;
  -webkit-user-select: none;
  user-select: none;
}

/* ===== LOADING SCREEN ===== */
#loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: #0500FF;
  z-index: 99999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-family: 'Monospace821Bold', monospace;
  color: #fff;
  transition: opacity 0.5s ease;
}

#loading-screen.fade-out {
  opacity: 0;
  pointer-events: none;
}

.loading-text {
  font-size: 3em;
  margin-bottom: 40px;
}

.loading-bar-container {
  width: 60%;
  max-width: 500px;
  height: 30px;
  border: 3px solid #fff;
  position: relative;
  overflow: hidden;
}

.loading-bar {
  height: 100%;
  background: #fff;
  width: 0%;
  transition: width 0.3s ease;
}

.loading-percentage {
  font-size: 2em;
  margin-top: 20px;
}

/* ===== RETICLE ===== */
#reticle {
  position: fixed;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid #fff;
  border-radius: 50%;
  pointer-events: none;
  z-index: 100;
  transition: all 0.2s ease;
  box-shadow: 0 0 10px rgba(255,255,255,0.5);
}

#reticle.hover {
  border-color: #0500FF;
  box-shadow: 0 0 20px rgba(5,0,255,0.8);
  transform: scale(1.3);
}

/* ===== MENU ===== */
#top-menu {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(5, 0, 255, 0.85);
  backdrop-filter: invert(100%) blur(5px);
  z-index: 9999;
  padding: 40px;
  box-sizing: border-box;
  overflow: hidden;
  align-items: left;
  justify-content: left;
  flex-direction: column;
}

#menu-logo {
  width: 150px;
  height: auto;
  margin-bottom: 40px;
  cursor: pointer;
}

#menu-logo img {
  width: 100%;
  height: auto;
}

#menu-pages {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 10px;
}

.menu-btn {
  font-family: 'monospace821';
  font-weight: 900;
  font-size: 8em;
  background: none;
  color: #ffffff;
  cursor: pointer;
  border: none;
  text-align: left;
  text-decoration: underline;
  padding: 5px 0;
  transition: color 0.2s;
  line-height: 1;
}



/* ===== POPUP ===== */
#popup {
  display: none;
  position: fixed;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(255,255,255,0.97);
  color: #222;
  font-family: 'Monospace821';
  z-index: 10001;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  font-size: 1em;
  transition: opacity 0.2s;
  overflow: hidden;
}

#popup .close-btn {
  position: absolute;
  top: 18px;
  right: 28px;
  font-size: 2em;
  color: #ff0000;
  background: none;
  border: none;
  cursor: pointer;
  z-index: 11;
  transition: color 0.2s;
  font-family: 'Monospace821Bold', monospace;
  line-height: 1;
}

#popup .close-btn:hover { 
  color: #222; 
}

#popup .popup-content-layout {
  display: flex;
  height: 100%;
  width: 100%;
  flex-direction: column;
}

#popup .popup-left {
  width: 100%;
  padding: 60px 24px 24px 24px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  border-bottom: 1.5px solid #e0e0e0;
  overflow-y: auto;
  position: relative;
  z-index: 1;
  max-height: 50%;
  flex-shrink: 0;
}

#popup .popup-left h2 {
  font-family: 'MacklinSansBold', 'monospace821Bold', sans-serif;
  margin-top: 0;
  margin-bottom: 10px;
}

#popup .popup-left p {
  margin: 0;
  line-height: 1.5;
}

#popup .popup-right {
  width: 100%;
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#popup .popup-images-scroll {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  -ms-overflow-style: none;
  scrollbar-width: none;
}

#popup .popup-images-scroll::-webkit-scrollbar { 
  width: 0; 
  height: 0; 
}

#popup .popup-images-scroll img {
  display: block;
  width: 100%;
  height: auto;
  object-fit: contain;
  cursor: pointer;
}

#popup .popup-images-scroll iframe {
  display: block;
  width: 100%;
  height: 100%;
  border: none;
}

#popup .image-row {
  display: flex;
  gap: 0px;
  width: 100%;
  align-items: stretch;
}

#popup .image-row img,
#popup .image-row video {
  flex: 1;
  height: 400px;
  object-fit: cover;
}

/* ===== IMAGE MODAL ===== */
#image-modal {
  display: none;
  position: fixed;
  z-index: 10002;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.85);
  align-items: center;
  justify-content: center;
  cursor: zoom-out;
}

#image-modal img {
  max-width: 90vw;
  max-height: 90vh;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  background: #fff;
}

#image-modal .modal-close-btn {
  position: absolute;
  top: 18px;
  right: 28px;
  font-size: 2em;
  color: #ff0000;
  background: none;
  border: none;
  cursor: pointer;
  z-index: 10003;
  font-family: 'Monospace821Bold', monospace;
  transition: color 0.2s;
}

#image-modal .modal-close-btn:hover { 
  color: #222; 
}

/* ===== DOOM POPUP ===== */
#doom-popup {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  justify-content: center;
  align-items: center;
  z-index: 10001;
}

#doom-popup-content {
  width: 100%;
  height: 100%;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: #000;
}

#doom-popup-close-btn {
  position: absolute;
  top: 18px;
  right: 28px;
  background: none;
  color: #ff0000;
  border: none;
  font-size: 2em;
  cursor: pointer;
  z-index: 10002;
  padding: 0;
  line-height: 1;
  font-family: 'Monospace821Bold', monospace;
  transition: color 0.2s;
}

#doom-popup-close-btn:hover {
  color: #222;
}

#dosbox {
  width: 100% !important;
  height: 100% !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

.dosbox-container {
  background: #000 !important;
  margin: 0 auto !important;
  width: 100% !important;
  height: 100% !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

.dosbox-container > canvas {
  width: 100% !important;
  height: 100% !important;
  object-fit: contain !important;
}

.dosbox-powered {
  opacity: 0 !important;
  display: none !important;
}

#doom-popup-instructions {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  color: #fff;
  background: rgba(0, 0, 0, 0.7);
  padding: 10px 20px;
  font-size: 14px;
  text-align: center;
  font-family: 'Monospace821', monospace;
  border-radius: 4px;
  z-index: 10003;
}

/* ===== CLICK PROMPT ===== */
#click-prompt {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-family: 'Monospace821Bold', monospace;
  font-size: 2em;
  color: #fff;
  background-color: #0500FF;
  text-align: center;
  z-index: 500;
  pointer-events: none;
  padding: 20px;
}

/* ===== MOBILE CONTROLS ===== */
#mobile-controls {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 200px;
  z-index: 1000;
  pointer-events: none;
}

.mobile-joystick {
  position: absolute;
  width: 120px;
  height: 120px;
  bottom: 40px;
  pointer-events: auto;
}

#movement-joystick {
  left: 40px;
}

.joystick-base {
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.2);
  border: 3px solid rgba(255, 255, 255, 0.5);
  border-radius: 50%;
  position: relative;
  image-rendering: pixelated;
}

.joystick-stick {
  width: 50px;
  height: 50px;
  background: rgba(255, 255, 255, 0.7);
  border: 2px solid #fff;
  border-radius: 50%;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  transition: none;
  image-rendering: pixelated;
  clip-path: polygon(
    0px calc(100% - 20px), 4px calc(100% - 20px), 4px calc(100% - 12px), 8px calc(100% - 12px),
    8px calc(100% - 8px), 12px calc(100% - 8px), 12px calc(100% - 4px), 20px calc(100% - 4px),
    20px 100%, calc(100% - 20px) 100%, calc(100% - 20px) calc(100% - 4px),
    calc(100% - 12px) calc(100% - 4px), calc(100% - 12px) calc(100% - 8px),
    calc(100% - 8px) calc(100% - 8px), calc(100% - 8px) calc(100% - 12px),
    calc(100% - 4px) calc(100% - 12px), calc(100% - 4px) calc(100% - 20px),
    100% calc(100% - 20px), 100% 20px, calc(100% - 4px) 20px, calc(100% - 4px) 12px,
    calc(100% - 8px) 12px, calc(100% - 8px) 8px, calc(100% - 12px) 8px,
    calc(100% - 12px) 4px, calc(100% - 20px) 4px, calc(100% - 20px) 0px, 20px 0px,
    20px 4px, 12px 4px, 12px 8px, 8px 8px, 8px 12px, 4px 12px, 4px 20px, 0px 20px
  );
}

/* ===== SHOTGUN GIF ===== */
#shotgun-gif {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 800px;
  height: auto;
  max-height: 1500px;
  z-index: 999;
  pointer-events: none;
  image-rendering: pixelated;
}

/* ===== MOBILE MENU BUTTON ===== */
#mobile-menu-btn {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1001;
  font-family: 'Monospace821Bold', monospace;
  font-size: 2em;
  color: #fff;
  background: rgba(5, 0, 255, 0.5);
  border: 2px solid #fff;
  padding: 8px 16px;
  cursor: pointer;
  display: none;
  pointer-events: auto;
  width: 50px;
  height: 50px;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
}
#mobile-menu-close {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  font-family: 'Monospace821Bold', monospace;
  font-size: 2em;
  color: #fff;
  background: none;
  border: none;
  cursor: pointer;
  display: none;
  pointer-events: auto;
  width: 60px;
  height: 60px;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

/* ===== MOBILE/TABLET RESPONSIVE ===== */
@media (max-width: 1024px) {
  #mobile-controls {
    display: block;
  }
  
  #mobile-menu-btn {
    display: flex;
  }
  
  #click-prompt {
    display: none !important;
  }
  
  .menu-btn {
    font-size: 10vw;
    width: 100%;
  }
  
  #menu-logo {
    width: 100px;
    margin-bottom: 30px;
  }
  
  #menu-random-gif {
    display: block;
    margin-top: 30px;
    width: 70%;
    max-width: 300px;
    height: auto;
    border: 3px solid #fff;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
  }
  
  .loading-text {
    font-size: 2em;
  }
  
  .loading-bar-container {
    width: 80%;
  }
  
  #popup .popup-content-layout {
    flex-direction: column !important;
  }
  
  #popup .popup-left {
    display: none !important;
  }
  
  #popup .popup-right {
    width: 100% !important;
    padding: 60px 0 0 0 !important;
  }

  #popup .popup-images-scroll {
    overflow-y: auto !important;
    padding: 0 !important;
    touch-action: pan-y !important;
  }
}

/* ===== DESKTOP RESPONSIVE ===== */
@media (min-width: 1025px) {
  #popup {
    left: 5vw;
    top: 5vh;
    width: 90vw;
    height: 90vh;
    border: 2px solid #333;
    border-radius: 1px;
  }
  
  #popup .popup-content-layout {
    flex-direction: row !important;
  }
  
  #popup .popup-left {
    width: 50% !important;
    max-height: 100% !important;
    border-right: 1.5px solid #e0e0e0 !important;
    border-bottom: none !important;
    padding: 24px 20px 24px 24px !important;
  }
  
  #popup .popup-right {
    width: 50% !important;
  }
  
  #menu-logo {
    position: absolute;
    top: 40px;
    right: 40px;
    width: 150px;
    margin-bottom: 0;
  }
  
  #menu-pages {
    position: absolute;
    top: 40px;
    left: 40px;
  }
  
  .menu-btn {
    font-size: 12em;
  }
  
  #menu-random-gif {
    display: none;
  }
}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/gifler@0.1.0/gifler.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://js-dos.com/cdn/js-dos-api.js"></script>
</head>
<body>

<!-- ===== LOADING SCREEN ===== -->
<div id="loading-screen">
  <div class="loading-text">|| LOADING ||</div>
  <div class="loading-bar-container">
    <div class="loading-bar" id="loading-bar"></div>
  </div>
  <div class="loading-percentage" id="loading-percentage">0%</div>
</div>

<!-- ===== RETICLE ===== -->
<div id="reticle"></div>

<!-- ===== CLICK PROMPT ===== -->
<div id="click-prompt">|| CLICK_TO_START || ESC=MENU</div>

<!-- ===== MENU ===== -->
<div id="top-menu" onclick="AboutApp.handleMenuClick(event)">
  <button id="mobile-menu-close" onclick="AboutApp.closeMenu()">&times;</button>
  <div id="menu-logo">
    <a href="index.html">
      <img src="assets/haumlogofinal.svg" alt="Logo">
    </a>
  </div>
  <div id="menu-pages">
    <button class="menu-btn" data-url="home.html">HOME</button>
    <button class="menu-btn" data-url="gallery.html">GALLERY</button>
    <button class="menu-btn" data-url="about.html">ABOUT</button>
  </div>
  <img id="menu-random-gif" src="" alt="Random GIF" style="display: none;">
</div>

<!-- ===== POPUP ===== -->
<div id="popup">
  <button class="close-btn" onclick="AboutApp.hidePopup()">&times;</button>
  <div id="popup-content"></div>
</div>

<!-- ===== IMAGE MODAL ===== -->
<div id="image-modal" onclick="AboutApp.closeImageModal(event)">
  <button class="modal-close-btn" onclick="AboutApp.closeImageModal(event)">&times;</button>
  <img id="modal-img" src="" alt="Popup Image">
</div>

<!-- ===== DOOM POPUP ===== -->
<div id="doom-popup">
  <button id="doom-popup-close-btn" onclick="AboutApp.hideDoomPopup()">×</button>
  <div id="doom-popup-content">
    <div id="dosbox"></div>
    <div id="doom-popup-instructions">
      Click on Screen, Press Enter to start | Arrows to move, W to use, S to Fire
    </div>
  </div>
</div>

<!-- ===== MOBILE MENU BUTTON ===== -->
<button id="mobile-menu-btn">+</button>

<!-- ===== SHOTGUN GIF ===== -->
<img id="shotgun-gif" src="assets/POVSHOTGUN_static.png" alt="Shotgun">

<!-- ===== MOBILE CONTROLS ===== -->
<div id="mobile-controls">
  <div id="movement-joystick" class="mobile-joystick">
    <div class="joystick-base">
      <div class="joystick-stick"></div>
    </div>
  </div>
</div>

<script>
const IS_MOBILE = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 1024;

// ===== CONFIG =====
const CONFIG = {
  IS_MOBILE,
  HOVER_DISTANCE: 80,
  CLICK_DISTANCE: 150,
  MOVEMENT_SPEED: 150,
  MOBILE_MOVEMENT_SPEED: 300,
  JUMP_FORCE: 250,
  MOUSE_SENSITIVITY: 0.002,
  MOBILE_LOOK_SENSITIVITY: 0.010,
  MOBILE_LIMIT_DRAW_DISTANCE: IS_MOBILE ? 400 : 500,
  
  gifUrls: [
    'assets/gifs/arach.gif', 'assets/gifs/baron.gif', 'assets/gifs/chomphead.gif', 
    'assets/gifs/dancingdino.gif', 'assets/gifs/dragonmouth.gif', 'assets/gifs/elemental.gif', 
    'assets/gifs/greendragon.gif', 'assets/gifs/jackhammer.gif', 'assets/gifs/legorun.gif', 
    'assets/gifs/orangedino.gif', 'assets/gifs/pinkydemon.gif', 'assets/gifs/shotgunblast.gif',
    'assets/gifs/skullfire.gif', 'assets/gifs/whitedragon.gif', 'assets/gifs/yellowdragon.gif'
  ]
};

// ===== LOADING MANAGER =====
const LoadingManager = {
  totalAssets: 0,
  loadedAssets: 0,
  isLoading: true,
  displayedPercentage: 0,
  targetPercentage: 0,
  smoothingInterval: null,
  
  init() {
    this.loadingScreen = document.getElementById('loading-screen');
    this.loadingBar = document.getElementById('loading-bar');
    this.loadingPercentage = document.getElementById('loading-percentage');
    this.startSmoothProgress();
  },
  
  startSmoothProgress() {
    this.smoothingInterval = setInterval(() => {
      if (this.displayedPercentage < this.targetPercentage) {
        this.displayedPercentage = Math.min(
          this.targetPercentage,
          this.displayedPercentage + Math.max(1, (this.targetPercentage - this.displayedPercentage) * 0.1)
        );
        this.loadingBar.style.width = Math.round(this.displayedPercentage) + '%';
        this.loadingPercentage.textContent = Math.round(this.displayedPercentage) + '%';
        
        if (this.displayedPercentage >= 100) {
          clearInterval(this.smoothingInterval);
          setTimeout(() => this.complete(), 500);
        }
      }
    }, 50);
  },
  
  setTotal(total) {
    this.totalAssets = total;
  },
  
  increment() {
    this.loadedAssets++;
    const actualPercentage = (this.loadedAssets / this.totalAssets) * 100;
    this.targetPercentage = actualPercentage;
    if (this.loadedAssets >= this.totalAssets) this.targetPercentage = 100;
  },
  
  complete() {
    this.isLoading = false;
    this.loadingScreen.classList.add('fade-out');
    setTimeout(() => this.loadingScreen.style.display = 'none', 500);
  }
};

// ===== SHOTGUN GIF =====
const ShotgunGif = {
  imgElement: null,
  isPlaying: false,
  staticFrameUrl: 'assets/POVSHOTGUN_static.png',
  animatedUrl: 'assets/POVSHOTGUN.gif',
  
  init() {
    this.imgElement = document.getElementById('shotgun-gif');
    this.imgElement.src = this.staticFrameUrl;
  },
  
  play() {
    if (this.isPlaying || !this.imgElement) return;
    this.isPlaying = true;
    this.imgElement.src = this.animatedUrl + '?' + Math.random();
    setTimeout(() => {
      this.imgElement.src = this.staticFrameUrl;
      this.isPlaying = false;
    }, 1500);
  }
};

// ===== INPUT MANAGER =====
const InputManager = {
  keys: {},
  pointerLocked: false,
  mobileMovement: { x: 0, z: 0 },
  mobileLookDelta: { x: 0, y: 0 },
  activeTouches: new Map(),
  
  init() {
document.addEventListener('keydown', (e) => {
  if (e.code === 'Escape') {
    e.preventDefault();
    if (AboutApp.popupVisible) {
      AboutApp.hidePopup();
      return;
    }
    if (AboutApp.doomPopupVisible) {
      AboutApp.hideDoomPopup();
      return;
    }
    AboutApp.toggleMenu();
    return;
  }
  this.keys[e.code] = true;
});
    
    document.addEventListener('keyup', (e) => this.keys[e.code] = false);
    
    if (!CONFIG.IS_MOBILE) {
      this.initDesktopControls();
    } else {
      this.initMobileControls();
      document.getElementById('click-prompt').style.display = 'none';
    }
  },
  
  initDesktopControls() {
    document.addEventListener('pointerlockchange', () => {
      const wasLocked = this.pointerLocked;
      this.pointerLocked = document.pointerLockElement === document.body;
      
      if (this.pointerLocked) {
        document.getElementById('click-prompt').style.display = 'none';
      }
      
    if (wasLocked && !this.pointerLocked && !AboutApp.menuOpen && !AboutApp.popupVisible && !AboutApp.doomPopupVisible && !AboutApp.popupJustClosed) {
        AboutApp.openMenu();
      }
    });
    
    document.addEventListener('click', () => {
      if (!this.pointerLocked && !AboutApp.popupVisible && !AboutApp.menuOpen && !AboutApp.doomPopupVisible && !LoadingManager.isLoading) {
        document.body.requestPointerLock();
      }
    });
  },
  
// FIND AND REPLACE THE ENTIRE initMobileControls FUNCTION:

initMobileControls() {
  this.initJoystick('movement-joystick', (x, y) => {
    this.mobileMovement.x = x;
    this.mobileMovement.z = y;
  });
  
  document.addEventListener('touchstart', (e) => {
    Array.from(e.changedTouches).forEach(touch => {
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      const isOnJoystick = target && target.closest('#movement-joystick');
      const isOnUI = target && (target.closest('#mobile-menu-btn') || target.closest('#popup') || target.closest('#top-menu'));
      
      this.activeTouches.set(touch.identifier, {
        startX: touch.clientX,
        startY: touch.clientY,
        lastX: touch.clientX,
        lastY: touch.clientY,
        isJoystick: isOnJoystick,
        isUI: isOnUI,
        isCameraControl: !isOnJoystick && !isOnUI,
        hasMoved: false,
        totalDistance: 0
      });
    });
  });
  
  document.addEventListener('touchmove', (e) => {
    if (AboutApp.popupVisible || AboutApp.menuOpen) return;
    
    Array.from(e.changedTouches).forEach(touch => {
      const touchData = this.activeTouches.get(touch.identifier);
      if (!touchData || !touchData.isCameraControl) return;
      
      const deltaX = touch.clientX - touchData.lastX;
      const deltaY = touch.clientY - touchData.lastY;
      
      const moveDist = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
      touchData.totalDistance += moveDist;
      
      if (touchData.totalDistance > 10) {
        touchData.hasMoved = true;
      }
      
      this.mobileLookDelta.x = deltaX;
      this.mobileLookDelta.y = deltaY;
      
      touchData.lastX = touch.clientX;
      touchData.lastY = touch.clientY;
    });
  });
  
  document.addEventListener('touchend', (e) => {
    Array.from(e.changedTouches).forEach(touch => {
      const touchData = this.activeTouches.get(touch.identifier);
      
      if (touchData && touchData.isCameraControl && !touchData.hasMoved && touchData.totalDistance < 20) {
        ShotgunGif.play();
        
        if (!AboutApp.popupVisible && !AboutApp.menuOpen && !AboutApp.doomPopupVisible && InteractionManager.hoveredBox) {
          const cameraPos = new THREE.Vector3();
          SceneManager.camera.getWorldPosition(cameraPos);
          const dist = cameraPos.distanceTo(InteractionManager.hoveredBox.position);
          
          if (dist <= CONFIG.CLICK_DISTANCE) {
            if (InteractionManager.hoveredBox.userData.isDoomArcade) {
              AboutApp.showDoomPopup();
            } else if (InteractionManager.hoveredBox.userData.isDisplay) {
              AboutApp.showPopup(InteractionManager.hoveredBox.userData.projectData);
            }
          }
        }
      }
      
      this.activeTouches.delete(touch.identifier);
    });
    
    if (!Array.from(this.activeTouches.values()).some(t => t.isCameraControl)) {
      this.mobileLookDelta.x = 0;
      this.mobileLookDelta.y = 0;
    }
  });
  
  document.getElementById('mobile-menu-btn').addEventListener('click', (e) => {
    e.preventDefault();
    AboutApp.toggleMenu();
  });
},
  
initJoystick(id, callback) {
  const joystick = document.getElementById(id);
  const stick = joystick.querySelector('.joystick-stick');
  const base = joystick.querySelector('.joystick-base');
  
  const handleMove = (e) => {
    e.preventDefault();
    
    let touch = null;
    if (e.touches) {
      for (let i = 0; i < e.touches.length; i++) {
        const t = e.touches[i];
        const touchData = this.activeTouches.get(t.identifier);
        if (touchData && touchData.isJoystick) {
          touch = t;
          break;
        }
      }
    }
    if (!touch) return;
    
    const rect = base.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    let deltaX = touch.clientX - centerX;
    let deltaY = touch.clientY - centerY;
    
    const maxDistance = rect.width / 2 - 25;
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    
    if (distance > maxDistance) {
      deltaX = (deltaX / distance) * maxDistance;
      deltaY = (deltaY / distance) * maxDistance;
    }
    
    stick.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
    callback(deltaX / maxDistance, deltaY / maxDistance);
  };
  
  const handleEnd = (e) => {
    e.preventDefault();
    
    // Check if any joystick touch still exists
    let hasJoystickTouch = false;
    if (e.touches) {
      for (let i = 0; i < e.touches.length; i++) {
        const touchData = this.activeTouches.get(e.touches[i].identifier);
        if (touchData && touchData.isJoystick) {
          hasJoystickTouch = true;
          break;
        }
      }
    }
    
    if (!hasJoystickTouch) {
      stick.style.transform = 'translate(-50%, -50%)';
      callback(0, 0);
    }
  };
  
  joystick.addEventListener('touchstart', (e) => {
    e.preventDefault();
  }, { passive: false });
  
  joystick.addEventListener('touchmove', handleMove, { passive: false });
  joystick.addEventListener('touchend', handleEnd, { passive: false });
  joystick.addEventListener('touchcancel', handleEnd, { passive: false });
},
  
  getMovementInput() {
    if (CONFIG.IS_MOBILE) {
      return { x: this.mobileMovement.x, z: this.mobileMovement.z };
    }
    return {
      x: (this.keys.KeyD || this.keys.ArrowRight ? 1 : 0) - (this.keys.KeyA || this.keys.ArrowLeft ? 1 : 0),
      z: (this.keys.KeyS || this.keys.ArrowDown ? 1 : 0) - (this.keys.KeyW || this.keys.ArrowUp ? 1 : 0)
    };
  }
};

// ===== SCENE MANAGER =====
const SceneManager = {
  scene: null,
  camera: null,
  renderer: null,
  yaw: null,
  pitch: null,
  objects: [],
  boxes: [],
  bigbox: null,
  doomArcade: null,
  displayBox: null,
  
  init() {
    this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
    this.pitch = new THREE.Object3D();
    this.pitch.add(this.camera);
    this.yaw = new THREE.Object3D();
    this.yaw.position.y = 20;
    this.yaw.add(this.pitch);
    this.yaw.rotation.y = 9.5;
    
this.scene = new THREE.Scene();
const skyUrl = CONFIG.IS_MOBILE 
  ? 'https://images.unsplash.com/photo-1647730096483-284aad556e20?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=687'
  : 'https://images.pexels.com/photos/531756/pexels-photo-531756.jpeg';
const skyTexture = new THREE.TextureLoader().load(skyUrl);
this.scene.background = skyTexture;
this.scene.fog = new THREE.Fog(0x87CEEB, 50, CONFIG.FOG_DISTANCE);
    
    this.scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 0.5));
    this.scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    
    if (!CONFIG.IS_MOBILE) {
      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(0, 300, 50);
      dirLight.castShadow = true;
      dirLight.shadow.mapSize.width = 2048;
      dirLight.shadow.mapSize.height = 2048;
      dirLight.shadow.camera.left = -150;
      dirLight.shadow.camera.right = 150;
      dirLight.shadow.camera.top = 300;
      dirLight.shadow.camera.bottom = -300;
      dirLight.shadow.camera.near = 1;
      dirLight.shadow.camera.far = 400;
      this.scene.add(dirLight);
    }
    this.scene.add(this.yaw);
    
    this.renderer = new THREE.WebGLRenderer({ 
      antialias: !CONFIG.IS_MOBILE,
      powerPreference: CONFIG.IS_MOBILE ? "low-power" : "high-performance"
    });
    this.renderer.setPixelRatio(CONFIG.IS_MOBILE ? 1 : window.devicePixelRatio);
    this.renderer.setSize(window.innerWidth, window.innerHeight);
    
    if (!CONFIG.IS_MOBILE) {
      this.renderer.shadowMap.enabled = true;
      this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    }
    
    document.body.appendChild(this.renderer.domElement);
    
    window.addEventListener('resize', () => {
      this.camera.aspect = window.innerWidth / window.innerHeight;
      this.camera.updateProjectionMatrix();
      this.renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
    LoadingManager.setTotal(3);
    this.createEnvironment();
  },
  
  createCheckeredTexture(size = 1024, squares = 32) {
    const canvas = document.createElement('canvas');
    canvas.width = canvas.height = size;
    const ctx = canvas.getContext('2d');
    const s = size / squares;
    for (let y = 0; y < squares; y++) {
      for (let x = 0; x < squares; x++) {
        ctx.fillStyle = (x + y) % 2 ? '#1976D2' : '#FFD600';
        ctx.fillRect(x * s, y * s, s, s);
      }
    }
    return new THREE.CanvasTexture(canvas);
  },
  
  createDeformedGeometry(geometry, deformAmount = 10) {
    const pos = geometry.attributes.position;
    const vertex = new THREE.Vector3();
    for (let i = 0; i < pos.count; i++) {
      vertex.fromBufferAttribute(pos, i);
      vertex.x += (Math.random() - 0.5) * deformAmount;
      vertex.y += (Math.random() - 0.5) * deformAmount;
      vertex.z += (Math.random() - 0.5) * deformAmount;
      pos.setXYZ(i, vertex.x, vertex.y, vertex.z);
    }
    return geometry;
  },
  
  createWall(width, height, segments, position, rotation, deformAmount = 10) {
    const geometry = this.createDeformedGeometry(
      new THREE.PlaneGeometry(width, height, segments[0], segments[1]),
      deformAmount
    );
    const texture = this.createCheckeredTexture();
    texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
    texture.repeat.set(2, 2);
    
    const wall = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide }));
    wall.position.set(...position);
    if (rotation) wall.rotation.set(...rotation);
    return wall;
  },
  
  createEnvironment() {
    const floorGeo = this.createDeformedGeometry(new THREE.PlaneGeometry(100, 200, 10, 20), 2);
    floorGeo.rotateX(-Math.PI / 2);
    const tex = this.createCheckeredTexture();
    tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
    tex.repeat.set(2, 2);
    const floor = new THREE.Mesh(floorGeo, new THREE.MeshStandardMaterial({ map: tex, side: THREE.DoubleSide }));
    floor.position.set(0, 4, 100);
    floor.receiveShadow = !CONFIG.IS_MOBILE;
    this.scene.add(floor);
    this.objects.push(floor);
    
    const walls = [
      this.createWall(220, 100, [10, 20], [-50, -1, 100], [0, Math.PI/2, -0.15]),
      this.createWall(220, 100, [10, 20], [50, 4, 100], [0, Math.PI/2, 0.15]),
      this.createWall(120, 100, [10, 20], [0, 4, 200], [0.15, 0, 0]),
      this.createWall(120, 100, [10, 20], [0, 4, 0], [-0.15, 0, 0])
    ];
    walls.forEach(wall => {
      this.scene.add(wall);
      this.objects.push(wall);
    });
    
    const geometry = new THREE.BoxGeometry(30, 30, 30);
    const textureLoader = new THREE.TextureLoader();
    
    const boxTexture = textureLoader.load(
      'assets/newvidsoon.webp',
      () => LoadingManager.increment(),
      undefined,
      () => {
        console.warn('Failed to load box texture');
        LoadingManager.increment();
      }
    );
    
    const material = new THREE.MeshStandardMaterial({ map: boxTexture });
    this.bigbox = new THREE.Mesh(geometry, material);
    this.bigbox.position.set(0, 20, 180);
    
    if (!CONFIG.IS_MOBILE) {
      this.bigbox.castShadow = true;
      this.bigbox.receiveShadow = true;
    }
    
    this.bigbox.userData.isDisplay = true;
    this.bigbox.userData.projectData = {
      title: "",
      description: "",
      media: [
        { type: "image", src: "assets/newvidsoon.webp" }
      ]
    };
    
    this.scene.add(this.bigbox);
    this.boxes.push(this.bigbox);
    
    const displayGeometry = new THREE.BoxGeometry(60, 35, 5);
    
    const displayTexture = textureLoader.load(
      'assets/aboutme.webp',
      () => LoadingManager.increment(),
      undefined,
      () => {
        console.warn('Failed to load display texture, using solid color');
        LoadingManager.increment();
      }
    );
    
    const displayMaterial = new THREE.MeshStandardMaterial({ 
      map: displayTexture,
      color: 0xffffff
    });
    
    this.displayBox = new THREE.Mesh(displayGeometry, displayMaterial);
    this.displayBox.position.set(-45, 25, 100);
    this.displayBox.rotation.y = Math.PI / 2;
    
    if (!CONFIG.IS_MOBILE) {
      this.displayBox.castShadow = true;
      this.displayBox.receiveShadow = true;
    }
    
    this.displayBox.userData.isDisplay = true;
    this.displayBox.userData.projectData = {
      title: "About Me",
      description: `Hi! I'm Soham, a student in graphic design at ECV Aix-en-Provence. I love pushing the limits of what I know and experimenting with new programs/ways of doing things. I honestly like most domains of design, but I definitely tend to have a little more interest in digital mediums.
      
      <div style="margin: 20px 0; display: flex; gap: 15px; align-items: center;">
        <a href="https://www.instagram.com/haum_kohli/" target="_blank" style="display: inline-block;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="#000000">
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
          </svg>
        </a>
        <a href="https://www.linkedin.com/in/haum/" target="_blank" style="display: inline-block;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="#000000">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
          </svg>
        </a>
      </div>
      
      <p style="margin: 20px 0 10px 0; font-style: italic;">Music is super important to the way I design and what inspires me so here is a little playlist with my current favorites!</p>
      
      <div style="margin-top: 15px;">
        <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/454e70CPg4oTs3RaZcuw9K?utm_source=generator&theme=0" width="100%" height="400" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
      </div>`,
      media: [
        { type: "image", src: "assets/me.webp" },
  
      ]
    };
    this.scene.add(this.displayBox);
    this.boxes.push(this.displayBox);
    
    if (!CONFIG.IS_MOBILE) {
      const arcadeGeometry = new THREE.BoxGeometry(12, 16, 3);
      const doomTexture = textureLoader.load(
        'assets/DOOMCOVER.webp',
        () => LoadingManager.increment(),
        undefined,
        () => LoadingManager.increment()
      );
      
      const arcadeMaterial = new THREE.MeshStandardMaterial({ map: doomTexture });
      this.doomArcade = new THREE.Mesh(arcadeGeometry, arcadeMaterial);
      this.doomArcade.position.set(45, 18, 100);
      this.doomArcade.rotation.y = -Math.PI / 2;
      this.doomArcade.castShadow = true;
      this.doomArcade.receiveShadow = true;
      this.doomArcade.userData.isDoomArcade = true;
      this.scene.add(this.doomArcade);
      this.boxes.push(this.doomArcade);
      
      const canvas = document.createElement('canvas');
      canvas.width = 512;
      canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 40px monospace';
      ctx.textAlign = 'center';
      ctx.fillText('CLICK TO PLAY', 256, 75);
      
      const textTexture = new THREE.CanvasTexture(canvas);
      const textGeometry = new THREE.PlaneGeometry(12, 4);
      const textMaterial = new THREE.MeshBasicMaterial({ 
        map: textTexture, 
        transparent: true,
        side: THREE.DoubleSide
      });
      const textMesh = new THREE.Mesh(textGeometry, textMaterial);
      textMesh.position.set(45, 28, 100);
      textMesh.rotation.y = -Math.PI / 2;
      this.scene.add(textMesh);
    } else {
      LoadingManager.increment();
    }
  }
};

// ===== PHYSICS MANAGER =====
const PhysicsManager = {
  velocity: new THREE.Vector3(),
  direction: new THREE.Vector3(),
  canJump: false,
  raycaster: new THREE.Raycaster(),
  
  update(delta) {
    const yaw = SceneManager.yaw;
    
    yaw.position.x = Math.max(-45, Math.min(45, yaw.position.x));
    yaw.position.z = Math.max(5, Math.min(195, yaw.position.z));
    
    this.raycaster.ray.origin.copy(yaw.position);
    this.raycaster.ray.origin.y += 1;
    this.raycaster.ray.direction.set(0, -1, 0);
    const hits = this.raycaster.intersectObjects(SceneManager.objects, false);
    const onGround = hits.length > 0 && hits[0].distance < 2;
    
    this.velocity.x -= this.velocity.x * 8 * delta;
    this.velocity.z -= this.velocity.z * 8 * delta;
    this.velocity.y -= 5 * 200 * delta;
    
    const input = InputManager.getMovementInput();
    this.direction.set(input.x, 0, input.z).normalize();
    
    const moveSpeed = CONFIG.IS_MOBILE ? CONFIG.MOBILE_MOVEMENT_SPEED : CONFIG.MOVEMENT_SPEED;
    
    if (this.direction.z) this.velocity.z -= this.direction.z * moveSpeed * delta;
    if (this.direction.x) this.velocity.x += this.direction.x * moveSpeed * delta;
    
    if (!onGround) {
      const speed = Math.sqrt(this.velocity.x * this.velocity.x + this.velocity.z * this.velocity.z);
      const maxAir = 300, airAccel = 400;
      if (this.direction.x && speed < maxAir) this.velocity.x += this.direction.x * airAccel * delta;
      if (this.direction.z && speed < maxAir) this.velocity.z -= this.direction.z * airAccel * delta;
    }
    
    if (onGround) {
      this.velocity.y = Math.max(0, this.velocity.y);
      this.canJump = true;
    }
    
    if (InputManager.keys.Space && this.canJump) {
      this.velocity.y += CONFIG.JUMP_FORCE;
      this.canJump = false;
    }
    
    const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(yaw.quaternion).setY(0).normalize();
    const right = new THREE.Vector3(1, 0, 0).applyQuaternion(yaw.quaternion).setY(0).normalize();
    yaw.position.addScaledVector(forward, this.velocity.z * delta);
    yaw.position.addScaledVector(right, this.velocity.x * delta);
    yaw.position.y += this.velocity.y * delta;
    
    if (yaw.position.y < 20) {
      this.velocity.y = 0;
      yaw.position.y = 20;
      this.canJump = true;
    }
  }
};

// ===== INTERACTION MANAGER =====
const InteractionManager = {
  raycaster: new THREE.Raycaster(),
  reticle: null,
  hoveredBox: null,
  
  init() {
    this.reticle = document.getElementById('reticle');
    
    if (!CONFIG.IS_MOBILE) {
      document.addEventListener('mousemove', (e) => {
        if (InputManager.pointerLocked && !AboutApp.popupVisible && !AboutApp.menuOpen && !AboutApp.doomPopupVisible) {
          SceneManager.yaw.rotation.y -= e.movementX * CONFIG.MOUSE_SENSITIVITY;
          SceneManager.pitch.rotation.x = Math.max(
            -Math.PI/2, 
            Math.min(Math.PI/2, SceneManager.pitch.rotation.x - e.movementY * CONFIG.MOUSE_SENSITIVITY)
          );
        }
      });
      
      document.addEventListener('click', (e) => {
        ShotgunGif.play();
        
        if (AboutApp.doomPopupVisible || AboutApp.popupVisible) {
          const popup = document.getElementById('popup');
          if (AboutApp.popupVisible) {
            const rect = popup.getBoundingClientRect();
            const clickedInside = e.clientX >= rect.left && e.clientX <= rect.right && 
                                 e.clientY >= rect.top && e.clientY <= rect.bottom;
            
            if (!clickedInside) {
              AboutApp.hidePopup();
            }
          }
          return;
        }
        
        if (!InputManager.pointerLocked || AboutApp.menuOpen) return;
        
        if (this.hoveredBox) {
          const cameraPos = new THREE.Vector3();
          SceneManager.camera.getWorldPosition(cameraPos);
          const dist = cameraPos.distanceTo(this.hoveredBox.position);
          
          if (dist <= CONFIG.CLICK_DISTANCE) {
            if (this.hoveredBox.userData.isDoomArcade) {
              AboutApp.showDoomPopup();
            } else if (this.hoveredBox.userData.isDisplay) {
              AboutApp.showPopup(this.hoveredBox.userData.projectData);
            }
          }
        }
      });
    }
  },
  
  update() {
    if (CONFIG.IS_MOBILE && (InputManager.mobileLookDelta.x !== 0 || InputManager.mobileLookDelta.y !== 0)) {
      SceneManager.yaw.rotation.y -= InputManager.mobileLookDelta.x * CONFIG.MOBILE_LOOK_SENSITIVITY;
      SceneManager.pitch.rotation.x = Math.max(
        -Math.PI/2,
        Math.min(Math.PI/2, SceneManager.pitch.rotation.x - InputManager.mobileLookDelta.y * CONFIG.MOBILE_LOOK_SENSITIVITY)
      );
    }
    
    if ((!CONFIG.IS_MOBILE && !InputManager.pointerLocked) || AboutApp.popupVisible || AboutApp.menuOpen || AboutApp.doomPopupVisible) {
      this.reticle.classList.remove('hover');
      this.hoveredBox = null;
      return;
    }
    
    this.raycaster.setFromCamera(new THREE.Vector2(0, 0), SceneManager.camera);
    const intersects = this.raycaster.intersectObjects(SceneManager.boxes);
    
    if (intersects.length > 0) {
      const obj = intersects[0].object;
      if (obj.userData.isDoomArcade || obj.userData.isDisplay) {
        const cameraPos = new THREE.Vector3();
        SceneManager.camera.getWorldPosition(cameraPos);
        const dist = cameraPos.distanceTo(obj.position);
        
        if (dist <= CONFIG.HOVER_DISTANCE) {
          this.reticle.classList.add('hover');
          this.hoveredBox = obj;
        } else {
          this.reticle.classList.remove('hover');
          this.hoveredBox = null;
        }
      }
    } else {
      this.reticle.classList.remove('hover');
      this.hoveredBox = null;
    }
  }
};

// ===== POPUP MANAGER =====
const PopupManager = {
  generateHTML(project) {
    const hasContent = project.title || project.description;
    
    const mediaContent = project.media.map(m => {
      if (m.type === "video") {
        const vimeoMatch = m.src.match(/vimeo\.com\/(\d+)/);
        if (vimeoMatch) {
          const videoId = vimeoMatch[1];
          return `<div style="width:100%;height:100%;min-height:${CONFIG.IS_MOBILE ? '100vh' : '85vh'};display:flex;align-items:center;justify-content:center;margin:0;background:#000;flex-shrink:0;">
            <iframe src="https://player.vimeo.com/video/${videoId}?background=0&autoplay=0&loop=0&byline=0&title=0&portrait=0&controls=1&sidedock=0" 
                    frameborder="0" 
                    allow="autoplay; fullscreen; picture-in-picture" 
                    style="width:100%;height:100%;" 
                    title="${project.title}">
            </iframe>
          </div>
          <script src="https://player.vimeo.com/api/player.js"><\/script>`;
        } else {
          return `<div style="width:100%;height:100%;min-height:${CONFIG.IS_MOBILE ? '100vh' : '85vh'};display:flex;align-items:center;justify-content:center;margin:0;background:#000;flex-shrink:0;">
            <video src="${m.src}" controls playsinline style="width:100%;height:100%;object-fit:contain;"></video>
          </div>`;
        }
      } else if (m.type === 'image' || m.type === 'img') {
        return `<img src="${m.src}" alt="${project.title}" onclick="AboutApp.openImageModal(this)" style="width:100%;height:auto;object-fit:contain;display:block;">`;
      } else {
        return '';
      }
    }).join('');
    
    if (!hasContent) {
      return `
        <div style="display:flex;width:100%;height:100%;align-items:center;justify-content:center;background:#fff;">
          ${mediaContent}
        </div>
      `;
    }
    
    const mobileHeader = CONFIG.IS_MOBILE ? `
      <div style="margin-bottom: 20px; padding: 0 24px;">
        <h2 style="font-family: 'MacklinSansBold', 'monospace821Bold', sans-serif; margin: 0 0 10px 0;">${project.title}</h2>
        <p style="font-family: 'Monospace821'; margin: 0; line-height: 1.5;">${project.description}</p>
      </div>
    ` : '';
    
    return `
      <div class="popup-content-layout">
        <div class="popup-left">
          <h2>${project.title}</h2>
          <p>${project.description}</p>
        </div>
        <div class="popup-right">
          <div class="popup-images-scroll">
            ${mobileHeader}${mediaContent}
          </div>
        </div>
      </div>
    `;
  }
};

// ===== MAIN APP =====
const AboutApp = {
  menuOpen: false,
  popupVisible: false,
  doomPopupVisible: false,
    popupJustClosed: false,
  animationId: null,
  prevTime: performance.now(),
  dosboxInstance: null,
  
  init() {
    LoadingManager.init();
    InputManager.init();
    SceneManager.init();
    InteractionManager.init();
    ShotgunGif.init();
    
    document.querySelectorAll('.menu-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const url = e.target.dataset.url;
        if (url) window.location.href = url;
      });
    });
    
    this.animate();
  },
  
  handleMenuClick(event) {
    if (event.target.id === 'top-menu') {
      this.closeMenu();
    }
  },
  
  toggleMenu() {
    this.menuOpen ? this.closeMenu() : this.openMenu();
  },
  
  openMenu() {
    if (this.menuOpen) return;
    this.menuOpen = true;
    const menu = document.getElementById('top-menu');
    menu.style.display = 'flex';
    
    if (CONFIG.IS_MOBILE) {
      const gifImg = document.getElementById('menu-random-gif');
      const randomGif = CONFIG.gifUrls[Math.floor(Math.random() * CONFIG.gifUrls.length)];
      gifImg.src = randomGif;
      gifImg.style.display = 'block';
      
      const closeBtn = document.getElementById('mobile-menu-close');
      closeBtn.style.display = 'flex';
    }
    
    if (!CONFIG.IS_MOBILE && document.pointerLockElement) {
      document.exitPointerLock();
    }
  },
  
  closeMenu() {
    if (!this.menuOpen) return;
    this.menuOpen = false;
    const menu = document.getElementById('top-menu');
    menu.style.display = 'none';
    
    if (CONFIG.IS_MOBILE) {
      const gifImg = document.getElementById('menu-random-gif');
      gifImg.style.display = 'none';
      gifImg.src = '';
      
      const closeBtn = document.getElementById('mobile-menu-close');
      closeBtn.style.display = 'none';
    }
    
    if (!CONFIG.IS_MOBILE) {
      document.body.requestPointerLock();
    }
  },
  
  showPopup(project) {
    const popup = document.getElementById('popup');
    const popupContent = document.getElementById('popup-content');
    popupContent.innerHTML = PopupManager.generateHTML(project);
    popup.style.display = 'flex';
    popup.style.opacity = '1';
    this.popupVisible = true;
    
    if (!CONFIG.IS_MOBILE && document.pointerLockElement) {
      document.exitPointerLock();
    }
  },
  
hidePopup() {
  const popup = document.getElementById('popup');
  const popupContent = document.getElementById('popup-content');
  
  // Stop all videos and iframes in the popup
  const videos = popupContent.querySelectorAll('video');
  videos.forEach(video => {
    video.pause();
    video.currentTime = 0;
    video.removeAttribute('src'); // Force mobile to release the video
    video.load(); // Reset the video element
  });
  
  const iframes = popupContent.querySelectorAll('iframe');
  iframes.forEach(iframe => {
    const src = iframe.src;
    iframe.src = 'about:blank'; // Immediately stop iframe
    setTimeout(() => iframe.src = '', 0);
  });
  
  popup.style.display = 'none';
  popup.style.opacity = '0';
  this.popupVisible = false;
  this.popupJustClosed = true;
  
  setTimeout(() => {
    this.popupJustClosed = false;
    if (!CONFIG.IS_MOBILE && !this.menuOpen) {
      document.body.requestPointerLock();
    }
  }, 150);
},
  showDoomPopup() {
    const popup = document.getElementById('doom-popup');
    popup.style.display = 'flex';
    this.doomPopupVisible = true;
    
    if (!CONFIG.IS_MOBILE && document.pointerLockElement) {
      document.exitPointerLock();
    }
    
    if (!this.dosboxInstance) {
      this.dosboxInstance = new Dosbox({
        id: "dosbox",
        onload: function (dosbox) {
          dosbox.run("https://js-dos.com/cdn/upload/DOOM-@evilution.zip", "./DOOM/DOOM.EXE");
        },
        onrun: function (dosbox, app) {
          console.log("App '" + app + "' is running");
        }
      });
    }
  },
  
  hideDoomPopup() {
    const popup = document.getElementById('doom-popup');
    popup.style.display = 'none';
    this.doomPopupVisible = false;
    window.location.reload();
  },
  
  openImageModal(imgElem) {
    event.stopPropagation();
    document.getElementById('modal-img').src = imgElem.src;
    document.getElementById('image-modal').style.display = 'flex';
  },
  
  closeImageModal(event) {
    if (event.target.id === 'image-modal' || event.target.className === 'modal-close-btn') {
      document.getElementById('image-modal').style.display = 'none';
      document.getElementById('modal-img').src = '';
    }
  },
  
  animate() {
    this.animationId = requestAnimationFrame(() => this.animate());
    
    const time = performance.now();
    const delta = (time - this.prevTime) / 1000;
    this.prevTime = time;
    
    if (!this.menuOpen && !this.popupVisible && !this.doomPopupVisible) {
      PhysicsManager.update(delta);
      InteractionManager.update();
      
      if (SceneManager.bigbox) {
        SceneManager.bigbox.rotation.y += 0.0003;
      }
    }
    
    SceneManager.renderer.render(SceneManager.scene, SceneManager.camera);
  }
};

AboutApp.init();
</script>
</body>
</html>
